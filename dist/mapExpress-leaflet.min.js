L.MapExpress={version:"0.0.1",Controls:{},Data:{},Geo:{},Layers:{},Utils:{},Mapping:{}},"undefined"!=typeof window&&window.L&&(window.L.MapExpress=L.MapExpress),function(){"use strict";L.MapExpress.Data.MapSourceProvider=L.Class.extend({statics:{},options:{},initialize:function(a){},getFeatureInfo:function(a){}}),L.MapExpress.Data.mapSourceProvider=function(a){return new L.MapExpress.Data.MapSourceProvider(a)}}.call(this),function(){"use strict";L.MapExpress.Data.RasterProvider=L.MapExpress.Data.MapSourceProvider.extend({initialize:function(a,b){L.MapExpress.Data.MapSourceProvider.prototype.initialize.call(this,b),L.setOptions(this,b),this._imageUrl=a},getMapImageUrl:function(a,b){return _imageUrl}}),L.MapExpress.Data.rasterProvider=function(a,b){return new L.MapExpress.Data.RasterProvider(a,b)}}.call(this),function(){"use strict";L.MapExpress.Data.TileProvider=L.MapExpress.Data.MapSourceProvider.extend({options:{maxZoom:23,subdomains:"abc"},initialize:function(a,b){L.MapExpress.Data.MapSourceProvider.prototype.initialize.call(this,b),L.setOptions(this,b),this._url=a,"string"==typeof this.options.subdomains&&(this.options.subdomains=this.options.subdomains.split(""))},getTileImage:function(a){var b=new Image;return b.src=this.getTileUrl(a),b},getTileUrl:function(a){return L.Util.template(this._url,L.extend({r:this.options.tileCoord&&L.Browser.retina&&this.options.maxZoom>0?"@2x":"",s:this._getSubdomain(a),x:a.x,y:a.y,z:a.z},this.options))},_getSubdomain:function(a){var b=Math.abs(a.x+a.y)%this.options.subdomains.length;return this.options.subdomains[b]}}),L.MapExpress.Data.tileProvider=function(a,b){return new L.MapExpress.Data.TileProvider(a,b)}}.call(this),function(){"use strict";L.MapExpress.Data.WmsProvider=L.MapExpress.Data.MapSourceProvider.extend({defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.1.1",layers:"",styles:"",format:"image/png",transparent:!1},options:{tileSize:256,crs:L.CRS.EPSG3857,uppercase:!1,maxZoom:23,subdomains:"abc"},initialize:function(a,b){L.MapExpress.Data.MapSourceProvider.prototype.initialize.call(this,b),this._url=a;var c=L.extend({},this.defaultWmsParams);for(var d in b)d in this.options||(c[d]=b[d]);b=L.setOptions(this,b),c.width=c.height=b.tileSize*(b.detectRetina&&L.Browser.retina?2:1),this.wmsParams=c},getTileImage:function(a){var b=this._tileCoordsToBounds(a),c=this.options.tileSize,d=new L.Point(c,this.options.tileSize);return this.getMapImage(b,d)},getMapImage:function(a,b){var c=new Image;return c.src=this.getMapImageUrl(a,b),c},getMapImageUrl:function(a,b){var c=parseFloat(this.wmsParams.version),d=this.options.crs,e=c>=1.3?"crs":"srs",f=d.project(a.getNorthWest()),g=d.project(a.getSouthEast()),h={width:b.x,height:b.y};h[e]=d.code,h.bbox=(c>=1.3&&d===L.CRS.EPSG4326?[g.y,f.x,f.y,g.x]:[f.x,g.y,g.x,f.y]).join(","),L.extend(this.wmsParams,h);var i=this.options.uppercase||!1,j=L.Util.getParamString(this.wmsParams,this._url,i);return this._url+j},_tileCoordsToBounds:function(a){var b=this.options.tileSize,c=L.CRS.EPSG3857,d=new L.Point(a.x*b,a.y*b),e=new L.Point(d.x+b,d.y+b),f=c.pointToLatLng(d,a.z),g=c.pointToLatLng(e,a.z),h=c.wrapLatLng(f),i=c.wrapLatLng(g);return new L.LatLngBounds(h,i)}}),L.MapExpress.Data.wmsProvider=function(a,b){return new L.MapExpress.Data.WmsProvider(a,b)}}.call(this),function(){"use strict";L.MapExpress.Layers.RasterSourceLayer=L.ImageOverlay.extend({initialize:function(a,b,c){this._rasterProvider=a;var d=this._rasterProvider.getMapImageUrl(this._bounds,this._map.getSize());L.ImageOverlay.prototype.initialize.call(this,d,b,c)}}),L.MapExpress.Layers.rasterSourceLayer=function(a,b,c){return new L.MapExpress.Layers.RasterSourceLayer(a,b,c)}}.call(this),function(){"use strict";L.MapExpress.Layers.TileServiceLayer=L.TileLayer.extend({initialize:function(a,b){L.TileLayer.prototype.initialize.call(this,null,b),this.tileProvider=a},createTile:function(a,b){var c=this.getTileImage(a);return L.DomEvent.on(c,"load",L.bind(this._tileOnLoad,this,b,c)),L.DomEvent.on(c,"error",L.bind(this._tileOnError,this,b,c)),this.options.crossOrigin&&(c.crossOrigin=""),c.alt="",c},getTileImage:function(a){return this.tileProvider.getTileImage(a)}}),L.MapExpress.Layers.tileServiceLayer=function(a,b){return new L.MapExpress.Layers.TileServiceLayer(a,b)}}.call(this),function(){"use strict";L.MapExpress.Layers.WmsImageOverlayLayer=L.ImageOverlay.extend({initialize:function(a,b){L.ImageOverlay.prototype.initialize.call(this,null,null,b),this._wmsProvider=a},getMapImageUrl:function(){return this._bounds=this._map.getBounds(),this._wmsProvider.getMapImageUrl(this._bounds,this._map.getSize())},getEvents:function(){var a={zoom:this._reset,viewreset:this._reset,moveend:this._reset};return this._zoomAnimated&&(a.zoomanim=this._animateZoom),a},_reset:function(){this._updateImage(),L.ImageOverlay.prototype._reset.call(this)},_updateImage:function(){this._bounds=this._map.getBounds(),this._url=this.getMapImageUrl(),L.DomUtil.remove(this._image),this.options.interactive&&this.removeInteractiveTarget(this._image),this._initImage(),this.options.opacity<1&&this._updateOpacity(),this.options.interactive&&(L.DomUtil.addClass(this._image,"leaflet-interactive"),this.addInteractiveTarget(this._image)),this.getPane().appendChild(this._image)}}),L.MapExpress.Layers.wmsImageOverlayLayer=function(a,b){return new L.MapExpress.Layers.WmsImageOverlayLayer(a,b)}}.call(this),function(){function a(b,c,d){this.maxSize_=b||-1,this.debug_=c||!1,this.storage_=d||new a.BasicCacheStorage,this.fillFactor_=.75,this.stats_={},this.stats_.hits=0,this.stats_.misses=0,this.log_("Initialized cache with size "+b)}a.Priority={LOW:1,NORMAL:2,HIGH:4},a.BasicCacheStorage=function(){this.items_={},this.count_=0},a.BasicCacheStorage.prototype.get=function(a){return this.items_[a]},a.BasicCacheStorage.prototype.set=function(a,b){"undefined"==typeof this.get(a)&&this.count_++,this.items_[a]=b},a.BasicCacheStorage.prototype.size=function(a,b){return this.count_},a.BasicCacheStorage.prototype.remove=function(a){var b=this.get(a);return"undefined"!=typeof b&&this.count_--,delete this.items_[a],b},a.BasicCacheStorage.prototype.keys=function(){var a,b=[];for(a in this.items_)b.push(a);return b},a.LocalStorageCacheStorage=function(a){this.prefix_="cache-storage."+(a||"default")+".";var b=this.prefix_.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");this.regexp_=new RegExp("^"+b)},a.LocalStorageCacheStorage.prototype.get=function(a){var b=window.localStorage[this.prefix_+a];return b?JSON.parse(b):null},a.LocalStorageCacheStorage.prototype.set=function(a,b){window.localStorage[this.prefix_+a]=JSON.stringify(b)},a.LocalStorageCacheStorage.prototype.size=function(a,b){return this.keys().length},a.LocalStorageCacheStorage.prototype.remove=function(a){var b=this.get(a);return delete window.localStorage[this.prefix_+a],b},a.LocalStorageCacheStorage.prototype.keys=function(){var a,b=[];for(a in window.localStorage)a.match(this.regexp_)&&b.push(a.replace(this.prefix_,""));return b},a.prototype.getItem=function(a){var b=this.storage_.get(a);null!=b&&(this.isExpired_(b)?(this.removeItem(a),b=null):b.lastAccessed=(new Date).getTime());var c=b?b.value:null;return c?(this.stats_.hits++,this.log_("Cache HIT for key "+a)):(this.stats_.misses++,this.log_("Cache MISS for key "+a)),c},a._CacheItem=function(b,c,d){if(!b)throw new Error("key cannot be null or empty");this.key=b,this.value=c,d=d||{},d.expirationAbsolute&&(d.expirationAbsolute=d.expirationAbsolute.getTime()),d.priority||(d.priority=a.Priority.NORMAL),this.options=d,this.lastAccessed=(new Date).getTime()},a.prototype.setItem=function(b,c,d){if(null!=this.storage_.get(b)&&this.removeItem(b),this.addItem_(new a._CacheItem(b,c,d)),this.log_("Setting key "+b),this.maxSize_>0&&this.size()>this.maxSize_){var e=this;setTimeout(function(){e.purge_.call(e)},0)}},a.prototype.clear=function(){for(var a=this.storage_.keys(),b=0;b<a.length;b++)this.removeItem(a[b]);this.log_("Cache cleared")},a.prototype.getStats=function(){return this.stats_},a.prototype.toHtmlString=function(){for(var a=this.size()+" item(s) in cache<br /><ul>",b=this.storage_.keys(),c=0;c<b.length;c++){var d=this.storage_.get(b[c]);a=a+"<li>"+d.key.toString()+" = "+d.value.toString()+"</li>"}return a+="</ul>"},a.prototype.resize=function(a){this.log_("Resizing Cache from "+this.maxSize_+" to "+a);var b=this.maxSize_;this.maxSize_=a,a>0&&(0>b||b>a)&&this.size()>a&&this.purge_(),this.log_("Resizing done")},a.prototype.purge_=function(){var a=new Array,b=Math.round(this.maxSize_*this.fillFactor_);this.maxSize_<0&&(b=this.size()*this.fillFactor_);for(var c=this.storage_.keys(),d=0;d<c.length;d++){var e=c[d],f=this.storage_.get(e);this.isExpired_(f)?this.removeItem(e):a.push(f)}if(a.length>b)for(a=a.sort(function(a,b){return a.options.priority!=b.options.priority?b.options.priority-a.options.priority:b.lastAccessed-a.lastAccessed});a.length>b;){var g=a.pop();this.removeItem(g.key)}this.log_("Purged cached")},a.prototype.addItem_=function(a,b){try{this.storage_.set(a.key,a)}catch(c){if(b)throw this.log_("Failed setting again, giving up: "+c.toString()),c;this.log_("Error adding item, purging and trying again: "+c.toString()),this.purge_(),this.addItem_(a,!0)}},a.prototype.removeItem=function(a){var b=this.storage_.remove(a);return this.log_("removed key "+a),b&&b.options&&b.options.callback&&setTimeout(function(){b.options.callback.call(null,b.key,b.value)},0),b?b.value:null},a.prototype.removeWhere=function(a){for(var b=this.storage_.keys(),c=0;c<b.length;c++){var d=b[c],e=this.storage_.get(d);a(d,e.value)===!0&&this.removeItem(d)}},a.prototype.size=function(){return this.storage_.size()},a.prototype.isExpired_=function(a){var b=(new Date).getTime(),c=!1;if(a.options.expirationAbsolute&&a.options.expirationAbsolute<b&&(c=!0),!c&&a.options.expirationSliding){var d=a.lastAccessed+1e3*a.options.expirationSliding;b>d&&(c=!0)}return c},a.prototype.log_=function(a){this.debug_&&console.log(a)};var b=this;"undefined"!=typeof module&&module.exports?module.exports=a:"function"==typeof define&&define.amd?define(function(){return a}):b.Cache=a}();